<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { background-color: #4A5568; color: #E2E8F0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Admin Access</h2>
            <input type="password" id="admin-key-input" class="w-full bg-gray-700 text-white p-2 rounded" placeholder="Enter Admin Key">
            <button id="login-button" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Login</button>
        </div>
    </div>

    <div id="dashboard-content" class="container mx-auto p-4 hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Admin Panel</h1>
            <button id="refresh-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Refresh Data</button>
        </header>

        <div class="mb-4 border-b border-gray-700">
            <nav class="flex flex-wrap space-x-4" aria-label="Tabs">
                <button class="tab-button active font-medium px-3 py-2 rounded-t-lg" data-tab="transactions">Transactions</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="volume">Live Volume</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="credit">Manual Credit</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="commission">Commission</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="market">Market Control</button>
            </nav>
        </div>

        <div>
            <div id="transactions-tab" class="tab-content active">
                <div class="mb-4">
                    <input type="text" id="search-input" class="w-full max-w-md bg-gray-700 p-2 rounded" placeholder="Search by username...">
                </div>
                <div class="overflow-x-auto bg-gray-800 rounded-lg p-4">
                    <table class="min-w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold">User Info</th>
                                <th class="p-3 text-left text-sm font-semibold">Balance</th>
                                <th class="p-3 text-left text-sm font-semibold">Total Deposits</th>
                                <th class="p-3 text-left text-sm font-semibold">Trade Volume</th>
                                <th class="p-3 text-left text-sm font-semibold">Referred By</th>
                                <th class="p-3 text-left text-sm font-semibold">Pending Deposits</th>
                                <th class="p-3 text-left text-sm font-semibold">Pending Withdrawals</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="volume-tab" class="tab-content">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h2 class="text-xl font-bold mb-4">Live Trade Exposure</h2>
                    <p class="text-sm text-gray-400 mb-4">This shows the total amount of money in active trades for each direction.</p>
                    <table class="min-w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold">Pair</th>
                                <th class="p-3 text-left text-sm font-semibold">Total UP Volume</th>
                                <th class="p-3 text-left text-sm font-semibold">Total DOWN Volume</th>
                                <th class="p-3 text-left text-sm font-semibold">Net Exposure</th>
                            </tr>
                        </thead>
                        <tbody id="volume-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="credit-tab" class="tab-content">
                <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-auto">
                    <h2 class="text-xl font-bold mb-4">Adjust User Balance</h2>
                    <form id="credit-form">
                        <div class="mb-4">
                            <label for="credit-username" class="block mb-2 text-sm font-medium">Username</label>
                            <input type="text" id="credit-username" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter exact username" required>
                        </div>
                        <div class="mb-4">
                            <label for="credit-amount" class="block mb-2 text-sm font-medium">Amount</label>
                            <input type="number" step="0.01" id="credit-amount" class="w-full bg-gray-700 p-2 rounded" placeholder="e.g., 100 or -50" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Submit Adjustment</button>
                    </form>
                </div>
            </div>

            <div id="commission-tab" class="tab-content">
                <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-auto">
                    <h2 class="text-xl font-bold mb-4">Award Referral Commission</h2>
                    <form id="commission-form">
                        <div class="mb-4">
                            <label for="commission-username" class="block mb-2 text-sm font-medium">Username</label>
                            <input type="text" id="commission-username" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter exact username of referrer" required>
                        </div>
                        <div class="mb-4">
                            <label for="commission-amount" class="block mb-2 text-sm font-medium">Commission Amount</label>
                            <input type="number" step="0.01" id="commission-amount" class="w-full bg-gray-700 p-2 rounded" placeholder="e.g., 5.00" required>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Award Commission</button>
                    </form>
                </div>
            </div>

            <div id="market-tab" class="tab-content">
                <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-auto text-center">
                    <h2 class="text-xl font-bold mb-4">Force Current Candle</h2>
                    <div class="mb-4">
                        <label for="pair-select" class="block mb-2 text-sm font-medium">Select Trading Pair</label>
                        <select id="pair-select" class="w-full bg-gray-700 p-2 rounded"></select>
                    </div>
                    <p class="mb-2">Current Status for Selected Pair: <strong id="market-status" class="text-xl"></strong></p>
                    <div class="flex justify-center space-x-4 mt-4">
                        <button class="market-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded" data-direction="up">Force UP</button>
                        <button class="market-btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded" data-direction="down">Force DOWN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getAdminKey = () => sessionStorage.getItem('adminKey');
            const setAdminKey = (key) => sessionStorage.setItem('adminKey', key);

            const loginModal = document.getElementById('login-modal');
            const dashboardContent = document.getElementById('dashboard-content');
            const adminKeyInput = document.getElementById('admin-key-input');
            const loginButton = document.getElementById('login-button');
            const refreshButton = document.getElementById('refresh-button');

            const usersTableBody = document.getElementById('users-table-body');
            const searchInput = document.getElementById('search-input');
            const creditForm = document.getElementById('credit-form');
            const commissionForm = document.getElementById('commission-form');
            const marketStatusEl = document.getElementById('market-status');
            const pairSelect = document.getElementById('pair-select');
            const volumeTableBody = document.getElementById('volume-table-body');

            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });

            const fetchData = async () => {
                const adminKey = getAdminKey();
                if (!adminKey) { showLogin(); return; }

                loginModal.style.display = 'none';
                dashboardContent.classList.remove('hidden');

                const searchTerm = searchInput.value;
                const url = searchTerm ? `/api/admin/data?search=${encodeURIComponent(searchTerm)}` : '/api/admin/data';

                try {
                    const response = await fetch(url, { headers: { 'x-admin-key': adminKey } });
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message);

                    usersTableBody.innerHTML = '';
                    (data.users || []).forEach(user => {
                        const row = document.createElement('tr');

                        const pendingDeposits = user.transactions.filter(tx => tx.status === 'pending_review');
                        let depositsHTML = pendingDeposits.length > 0 ? '' : '<p class="text-gray-500 text-xs">None</p>';
                        pendingDeposits.forEach(tx => {
                            depositsHTML += `<div class="my-2 p-2 bg-gray-700 rounded"><p class="text-xs break-all"><strong>TXID:</strong> ${tx.txid}</p><input type="number" step="0.01" class="w-full bg-gray-600 p-1 rounded mt-1 text-xs" placeholder="Amount"><div class="mt-2"><button class="approve-deposit-btn bg-green-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Approve</button> <button class="reject-deposit-btn bg-red-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Reject</button></div></div>`;
                        });

                        const pendingWithdrawals = user.transactions.filter(tx => tx.status === 'pending_processing');
                        let withdrawalsHTML = pendingWithdrawals.length > 0 ? '' : '<p class="text-gray-500 text-xs">None</p>';
                        pendingWithdrawals.forEach(tx => {
                            withdrawalsHTML += `<div class="my-2 p-2 bg-gray-700 rounded"><p class="text-sm font-bold">$${tx.amount.toFixed(2)}</p><p class="text-xs break-all"><strong>To:</strong> ${tx.address}</p><div class="mt-2"><button class="approve-withdrawal-btn bg-green-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Approve</button> <button class="reject-withdrawal-btn bg-red-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Reject</button></div></div>`;
                        });

                        const referrerUsername = user.referredBy ? user.referredBy.username : '<span class="text-gray-500">N/A</span>';

                        // ADDED: Formatting for the new data fields
                        const formattedBalance = (user.balance || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                        const formattedDeposits = (user.totalDeposits || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                        const formattedVolume = (user.totalTradeVolume || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

                        // MODIFIED: Added new cells to the table row
                        row.innerHTML = `
                            <td class="p-3 align-top text-sm"><strong>${user.username}</strong></td>
                            <td class="p-3 align-top text-sm font-mono">${formattedBalance}</td>
                            <td class="p-3 align-top text-sm font-mono">${formattedDeposits}</td>
                            <td class="p-3 align-top text-sm font-mono">${formattedVolume}</td>
                            <td class="p-3 align-top text-sm">${referrerUsername}</td>
                            <td class="p-3 align-top">${depositsHTML}</td>
                            <td class="p-3 align-top">${withdrawalsHTML}</td>`;
                        usersTableBody.appendChild(row);
                    });

                    const volumeByPair = {};
                    (data.tradePairs || []).forEach(pair => {
                        volumeByPair[pair] = { UP: 0, DOWN: 0 };
                    });
                    (data.tradeVolume || []).forEach(item => {
                        if (volumeByPair[item._id.asset]) {
                            volumeByPair[item._id.asset][item._id.direction] = item.totalAmount;
                        }
                    });
                    volumeTableBody.innerHTML = '';
                    for (const pair in volumeByPair) {
                        const upVolume = volumeByPair[pair].UP;
                        const downVolume = volumeByPair[pair].DOWN;
                        const netExposure = upVolume - downVolume;
                        const netColor = netExposure > 0 ? 'text-green-400' : (netExposure < 0 ? 'text-red-400' : '');
                        const rowHTML = `<tr>
                            <td class="p-3 font-bold">${pair}</td>
                            <td class="p-3 text-green-400">$${upVolume.toFixed(2)}</td>
                            <td class="p-3 text-red-400">$${downVolume.toFixed(2)}</td>
                            <td class="p-3 font-bold ${netColor}">$${netExposure.toFixed(2)}</td>
                        </tr>`;
                        volumeTableBody.innerHTML += rowHTML;
                    }

                    if (pairSelect.options.length === 0 && data.tradePairs) {
                        data.tradePairs.forEach(pair => {
                            const option = document.createElement('option');
                            option.value = pair;
                            option.textContent = pair;
                            pairSelect.appendChild(option);
                        });
                    }
                    if (data.marketStatus) {
                        updateMarketStatus(data.marketStatus);
                    }

                } catch (error) {
                    alert(`Error fetching data: ${error.message}`);
                    showLogin();
                }
            };

            const updateMarketStatus = (marketStatus) => {
                const selectedPair = pairSelect.value;
                const status = (marketStatus && marketStatus[selectedPair]) || 'Auto';
                marketStatusEl.textContent = status.toUpperCase();
                marketStatusEl.className = status === 'up' ? 'text-green-400' : status === 'down' ? 'text-red-400' : 'text-yellow-400';
            };

            const handleApiAction = async (url, body) => {
                const adminKey = getAdminKey();
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
                        body: JSON.stringify(body)
                    });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message);
                    alert(result.message);
                    fetchData();
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            };

            const showLogin = () => {
                sessionStorage.removeItem('adminKey');
                loginModal.style.display = 'flex';
                dashboardContent.classList.add('hidden');
            };

            loginButton.addEventListener('click', () => {
                const key = adminKeyInput.value;
                if (key) { setAdminKey(key); fetchData(); }
            });

            refreshButton.addEventListener('click', fetchData);
            searchInput.addEventListener('input', fetchData);

            usersTableBody.addEventListener('click', e => {
                if (e.target.classList.contains('approve-deposit-btn')) {
                    const amountInput = e.target.parentElement.previousElementSibling;
                    const amount = amountInput.value;
                    if (!amount || isNaN(parseFloat(amount))) return alert('Please enter a valid amount.');
                    handleApiAction('/api/admin/approve-deposit', { userId: e.target.dataset.userid, txid: e.target.dataset.txid, amount: parseFloat(amount) });
                }
                if (e.target.classList.contains('reject-deposit-btn')) {
                    handleApiAction('/api/admin/reject-deposit', { userId: e.target.dataset.userid, txid: e.target.dataset.txid });
                }
                if (e.target.classList.contains('approve-withdrawal-btn')) {
                    handleApiAction('/api/admin/approve-withdrawal', { userId: e.target.dataset.userid, txid: e.target.dataset.txid });
                }
                if (e.target.classList.contains('reject-withdrawal-btn')) {
                    handleApiAction('/api/admin/reject-withdrawal', { userId: e.target.dataset.userid, txid: e.target.dataset.txid });
                }
            });

            creditForm.addEventListener('submit', e => {
                e.preventDefault();
                const username = document.getElementById('credit-username').value;
                const amount = document.getElementById('credit-amount').value;
                handleApiAction('/api/admin/credit-user', { username, amount });
                creditForm.reset();
            });

            commissionForm.addEventListener('submit', e => {
                e.preventDefault();
                const username = document.getElementById('commission-username').value;
                const amount = document.getElementById('commission-amount').value;
                handleApiAction('/api/admin/give-commission', { username, amount });
                commissionForm.reset();
            });

            document.querySelectorAll('.market-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const pair = pairSelect.value;
                    if (!pair) return alert('Please select a trading pair first.');
                    const direction = button.dataset.direction === 'null' ? null : button.dataset.direction;
                    handleApiAction('/api/admin/market-control', { pair, direction });
                });
            });

            pairSelect.addEventListener('change', fetchData);

            if (getAdminKey()) { fetchData(); } else { showLogin(); }
        });
    </script>
</body>
</html>
