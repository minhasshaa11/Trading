<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { background-color: #4A5568; color: #E2E8F0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Custom styles for the Admin Chat */
        .admin-message {
            background-color: #4C51BF; /* Indigo for admin */
            align-self: flex-end;
            margin-left: auto;
        }

        .user-message {
            background-color: #4A5568; /* Gray for user */
            align-self: flex-start;
            margin-right: auto;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Admin Access</h2>
            <input type="password" id="admin-key-input" class="w-full bg-gray-700 text-white p-2 rounded" placeholder="Enter Admin Key">
            <button id="login-button" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Login</button>
        </div>
    </div>

    <div id="dashboard-content" class="container mx-auto p-4 hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Admin Panel</h1>
            <button id="refresh-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Refresh Data</button>
        </header>

        <div class="mb-4 border-b border-gray-700">
            <nav class="flex flex-wrap space-x-4" aria-label="Tabs">
                <button class="tab-button active font-medium px-3 py-2 rounded-t-lg" data-tab="transactions">Transactions</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="credit">Manual Credit</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="commission">Commission</button>
                <button class="tab-button font-medium px-3 py-2 rounded-t-lg" data-tab="support">Support Chat</button>
            </nav>
        </div>

        <div>
            <div id="transactions-tab" class="tab-content active">
                <div class="mb-4">
                    <input type="text" id="search-input" class="w-full max-w-md bg-gray-700 p-2 rounded" placeholder="Search by username...">
                </div>
                <div class="overflow-x-auto bg-gray-800 rounded-lg p-4">
                    <table class="min-w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold">User Info</th>
                                <th class="p-3 text-left text-sm font-semibold">Balance</th>
                                <th class="p-3 text-left text-sm font-semibold">Total Deposits</th>
                                <th class="p-3 text-left text-sm font-semibold">Trade Volume</th>
                                <th class="p-3 text-left text-sm font-semibold">Referred By</th>
                                <th class="p-3 text-left text-sm font-semibold">Pending Deposits</th>
                                <th class="p-3 text-left text-sm font-semibold">Pending Withdrawals</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="credit-tab" class="tab-content">
                 <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-auto">
                     <h2 class="text-xl font-bold mb-4">Adjust User Balance</h2>
                     <form id="credit-form">
                         <div class="mb-4">
                             <label for="credit-username" class="block mb-2 text-sm font-medium">Username</label>
                             <input type="text" id="credit-username" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter exact username" required>
                         </div>
                         <div class="mb-4">
                             <label for="credit-amount" class="block mb-2 text-sm font-medium">Amount</label>
                             <input type="number" step="0.01" id="credit-amount" class="w-full bg-gray-700 p-2 rounded" placeholder="e.g., 100 or -50" required>
                         </div>
                         <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Submit Adjustment</button>
                     </form>
                 </div>
            </div>

            <div id="commission-tab" class="tab-content">
                 <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-auto">
                     <h2 class="text-xl font-bold mb-4">Award Referral Commission</h2>
                     <form id="commission-form">
                         <div class="mb-4">
                             <label for="commission-username" class="block mb-2 text-sm font-medium">Username</label>
                             <input type="text" id="commission-username" class="w-full bg-gray-700 p-2 rounded" placeholder="Enter exact username of referrer" required>
                         </div>
                         <div class="mb-4">
                             <label for="commission-amount" class="block mb-2 text-sm font-medium">Commission Amount</label>
                             <input type="number" step="0.01" id="commission-amount" class="w-full bg-gray-700 p-2 rounded" placeholder="e.g., 5.00" required>
                         </div>
                         <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Award Commission</button>
                     </form>
                 </div>
            </div>
            
            <div id="support-tab" class="tab-content">
                <div class="bg-gray-800 rounded-lg p-6 flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 bg-gray-700 p-4 rounded-lg overflow-y-auto" style="min-height: 600px; max-height: 600px;">
                        <h2 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Open Tickets (<span id="ticket-count">0</span>)</h2>
                        <div id="ticket-list-container" class="space-y-3">
                            <p id="tickets-loading" class="text-gray-400 text-center">Loading tickets...</p>
                            </div>
                    </div>
                    
                    <div class="w-full md:w-2/3 bg-gray-700 p-4 rounded-lg flex flex-col">
                        <h2 id="current-chat-header" class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Select a Ticket to View</h2>
                        <div id="admin-chat-window" class="flex-1 overflow-y-auto space-y-3 flex flex-col-reverse" style="max-height: 450px;">
                            <p id="chat-placeholder" class="text-gray-500 text-center p-12">No chat selected.</p>
                            </div>
                        
                        <div class="mt-4 flex">
                            <input type="text" id="admin-message-input" class="flex-1 bg-gray-800 p-3 rounded-l-lg text-white border-0" placeholder="Type a reply...">
                            <button id="admin-send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-r-lg disabled:opacity-50" disabled>
                                Send
                            </button>
                        </div>
                        <p id="chat-error" class="text-red-400 text-xs mt-2 hidden">Error sending message.</p>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getAdminKey = () => sessionStorage.getItem('adminKey');
            const setAdminKey = (key) => sessionStorage.setItem('adminKey', key);

            const loginModal = document.getElementById('login-modal');
            const dashboardContent = document.getElementById('dashboard-content');
            const adminKeyInput = document.getElementById('admin-key-input');
            const loginButton = document.getElementById('login-button');
            const refreshButton = document.getElementById('refresh-button');

            const usersTableBody = document.getElementById('users-table-body');
            const searchInput = document.getElementById('search-input');
            const creditForm = document.getElementById('credit-form');
            const commissionForm = document.getElementById('commission-form');

            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // NEW SUPPORT CHAT VARIABLES
            const ticketsLoading = document.getElementById('tickets-loading');
            const ticketListContainer = document.getElementById('ticket-list-container');
            const ticketCountEl = document.getElementById('ticket-count');
            const currentChatHeader = document.getElementById('current-chat-header');
            const adminChatWindow = document.getElementById('admin-chat-window');
            const adminMessageInput = document.getElementById('admin-message-input');
            const adminSendBtn = document.getElementById('admin-send-btn');
            const chatPlaceholder = document.getElementById('chat-placeholder');
            const chatError = document.getElementById('chat-error');

            let currentOpenChatId = null;
            let currentChatUsername = null; 
            // END NEW SUPPORT CHAT VARIABLES


            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                    
                    // Trigger ticket refresh when the support tab is clicked
                    if (tab.dataset.tab === 'support') {
                        fetchTickets();
                    }
                });
            });


            // NEW SUPPORT CHAT FUNCTIONS
            const renderMessage = (message, username) => {
                const isAdmin = message.sender === 'admin';
                const messageEl = document.createElement('div');
                messageEl.className = `message p-3 rounded-lg text-sm ${isAdmin ? 'admin-message' : 'user-message'}`;
                messageEl.innerHTML = `
                    <p class="font-bold text-xs mb-1">${isAdmin ? 'Admin' : username}</p>
                    <p>${message.content}</p>
                    <span class="block text-xs mt-1 opacity-70 text-right">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                `;
                return messageEl;
            };

            const fetchTickets = async () => {
                ticketListContainer.innerHTML = '';
                ticketListContainer.appendChild(ticketsLoading);
                ticketsLoading.classList.remove('hidden');
                
                const adminKey = getAdminKey();
                if (!adminKey) return;

                try {
                    // API Endpoint: Get list of open tickets
                    const response = await fetch('/api/admin/support/tickets', { headers: { 'x-admin-key': adminKey } });
                    const data = await response.json();

                    ticketsLoading.classList.add('hidden');
                    if (!data.success) throw new Error(data.message);

                    const tickets = data.tickets || [];
                    ticketCountEl.textContent = tickets.length;
                    
                    if (tickets.length === 0) {
                        ticketListContainer.innerHTML = '<p class="text-gray-400 text-center p-4">No open support tickets.</p>';
                        return;
                    }

                    tickets.forEach(ticket => {
                        const ticketEl = document.createElement('div');
                        const isActive = ticket._id === currentOpenChatId;
                        ticketEl.className = `ticket-item p-3 rounded-lg cursor-pointer transition-colors ${isActive ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-900'}`;
                        ticketEl.dataset.chatid = ticket._id;
                        ticketEl.dataset.username = ticket.user.username;

                        const lastMessage = ticket.lastMessage ? ticket.lastMessage.content.substring(0, 40) + '...' : 'New chat started.';
                        const statusIndicator = ticket.status === 'pending_admin_reply' 
                            ? '<p class="text-xs text-yellow-300 mt-1">❗ Awaiting Reply</p>' 
                            : '<p class="text-xs text-gray-400 mt-1">Status: Open</p>';

                        ticketEl.innerHTML = `
                            <p class="font-bold text-white">${ticket.user.username}</p>
                            <p class="text-xs text-gray-400">Last: ${lastMessage}</p>
                            ${statusIndicator}
                        `;
                        
                        ticketEl.addEventListener('click', () => openChat(ticket._id, ticket.user.username));
                        ticketListContainer.appendChild(ticketEl);
                    });

                } catch (error) {
                    ticketsLoading.textContent = `Error: ${error.message}`;
                }
            };
            
            const openChat = async (chatId, username) => {
                // Reset UI
                currentOpenChatId = chatId;
                currentChatUsername = username;
                adminChatWindow.innerHTML = '';
                chatPlaceholder.classList.add('hidden');
                adminSendBtn.disabled = false;
                currentChatHeader.textContent = `Chat with ${username}`;
                
                // Update active ticket highlight
                document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('bg-blue-600'));
                const activeTicket = document.querySelector(`.ticket-item[data-chatid="${chatId}"]`);
                if (activeTicket) activeTicket.classList.add('bg-blue-600');

                // Fetch messages
                const adminKey = getAdminKey();
                try {
                    // API Endpoint: Get messages for a specific chat
                    const response = await fetch(`/api/admin/support/messages/${chatId}`, { headers: { 'x-admin-key': adminKey } });
                    const data = await response.json();

                    if (!data.success) throw new Error(data.message);

                    data.messages.forEach(msg => {
                        // Prepend to show newest at bottom (due to flex-col-reverse)
                        adminChatWindow.prepend(renderMessage(msg, username)); 
                    });
                    
                    adminChatWindow.scrollTop = adminChatWindow.scrollHeight; // Scroll to bottom
                    
                } catch (error) {
                    currentChatHeader.textContent = 'Error Loading Chat';
                    adminSendBtn.disabled = true;
                }
            };
            
            const sendAdminReply = async () => {
                const content = adminMessageInput.value.trim();
                if (!content || !currentOpenChatId) return;

                adminMessageInput.value = '';
                adminSendBtn.disabled = true;

                // Optimistically render
                const tempMessage = { content, sender: 'admin', timestamp: new Date() };
                adminChatWindow.prepend(renderMessage(tempMessage, currentChatUsername));
                adminChatWindow.scrollTop = adminChatWindow.scrollHeight;

                const adminKey = getAdminKey();
                try {
                    // API Endpoint: Send admin reply and update status
                    const response = await fetch('/api/admin/support/send-reply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
                        body: JSON.stringify({ chatId: currentOpenChatId, content })
                    });
                    const data = await response.json();

                    if (!data.success) {
                        chatError.classList.remove('hidden');
                        // In a production app, you would handle message failure/rollback here
                    } else {
                        chatError.classList.add('hidden');
                        // Refresh ticket list to update status indicator
                        fetchTickets();
                    }
                } catch (error) {
                    chatError.textContent = 'Network error: Reply failed.';
                    chatError.classList.remove('hidden');
                } finally {
                    adminSendBtn.disabled = false;
                    adminMessageInput.focus();
                }
            };

            adminSendBtn.addEventListener('click', sendAdminReply);
            adminMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendAdminReply();
            });
            // END NEW SUPPORT CHAT FUNCTIONS


            const fetchData = async () => {
                const adminKey = getAdminKey();
                if (!adminKey) { showLogin(); return; }

                loginModal.style.display = 'none';
                dashboardContent.classList.remove('hidden');

                const searchTerm = searchInput.value;
                const url = searchTerm ? `/api/admin/data?search=${encodeURIComponent(searchTerm)}` : '/api/admin/data';

                try {
                    // This fetches the transactions/users data for the first tab
                    const response = await fetch(url, { headers: { 'x-admin-key': adminKey } });
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message);

                    usersTableBody.innerHTML = '';
                    (data.users || []).forEach(user => {
                        const row = document.createElement('tr');

                        const pendingDeposits = user.transactions.filter(tx => tx.status === 'pending_review');
                        let depositsHTML = pendingDeposits.length > 0 ? '' : '<p class="text-gray-500 text-xs">None</p>';
                        
                        pendingDeposits.forEach(tx => {
                            depositsHTML += `<div class="my-2 p-2 bg-gray-700 rounded">
                                <p class="font-bold text-green-400">$${(tx.amount || 0).toFixed(2)}</p>
                                <p class="text-xs break-all"><strong>TXID:</strong> ${tx.txid}</p>
                                <div class="mt-2">
                                    <button class="approve-deposit-btn bg-green-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}" data-amount="${tx.amount}">Approve</button> 
                                    <button class="reject-deposit-btn bg-red-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Reject</button>
                                </div>
                            </div>`;
                        });

                        const pendingWithdrawals = user.transactions.filter(tx => tx.status === 'pending_processing');
                        let withdrawalsHTML = pendingWithdrawals.length > 0 ? '' : '<p class="text-gray-500 text-xs">None</p>';
                        pendingWithdrawals.forEach(tx => {
                            withdrawalsHTML += `<div class="my-2 p-2 bg-gray-700 rounded"><p class="text-sm font-bold">$${tx.amount.toFixed(2)}</p><p class="text-xs break-all"><strong>To:</strong> ${tx.address}</p><div class="mt-2"><button class="approve-withdrawal-btn bg-green-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Approve</button> <button class="reject-withdrawal-btn bg-red-600 text-xs p-1 rounded" data-userid="${user._id}" data-txid="${tx.txid}">Reject</button></div></div>`;
                        });

                        const referrerUsername = user.referredBy ? user.referredBy.username : '<span class="text-gray-500">N/A</span>';
                        
                        const formattedBalance = (user.balance || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                        const formattedDeposits = (user.totalDeposits || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                        const formattedVolume = (user.totalTradeVolume || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

                        const userInfoHTML = `
                            <div>
                                <strong>${user.username}</strong>
                                <p class="text-xs text-gray-400">${user.email || 'No email'}</p>
                            </div>`;

                        row.innerHTML = `
                            <td class="p-3 align-top text-sm">${userInfoHTML}</td>
                            <td class="p-3 align-top text-sm font-mono">${formattedBalance}</td>
                            <td class="p-3 align-top text-sm font-mono">${formattedDeposits}</td>
                            <td class="p-3 align-top text-sm font-mono">${formattedVolume}</td>
                            <td class="p-3 align-top text-sm">${referrerUsername}</td>
                            <td class="p-3 align-top">${depositsHTML}</td>
                            <td class="p-3 align-top">${withdrawalsHTML}</td>`;
                        usersTableBody.appendChild(row);
                    });

                } catch (error) {
                    alert(`Error fetching data: ${error.message}`);
                    showLogin();
                }
            };

            const handleApiAction = async (url, body) => {
                 const adminKey = getAdminKey();
                 try {
                     const response = await fetch(url, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
                         body: JSON.stringify(body)
                     });
                     const result = await response.json();
                     if (!result.success) throw new Error(result.message);
                     alert(result.message);
                     fetchData();
                 } catch (error) {
                     alert(`Error: ${error.message}`);
                 }
            };
            
            const showLogin = () => {
                sessionStorage.removeItem('adminKey');
                loginModal.style.display = 'flex';
                dashboardContent.classList.add('hidden');
            };

            loginButton.addEventListener('click', () => {
                const key = adminKeyInput.value;
                if (key) { setAdminKey(key); fetchData(); }
            });

            refreshButton.addEventListener('click', () => { 
                fetchData(); 
                // Only refresh tickets if the support tab is active
                if (document.querySelector('.tab-button[data-tab="support"]').classList.contains('active')) {
                    fetchTickets();
                }
            });
            
            searchInput.addEventListener('input', fetchData);

            usersTableBody.addEventListener('click', e => {
                if (e.target.classList.contains('approve-deposit-btn')) {
                    const amount = e.target.dataset.amount;
                    handleApiAction('/api/admin/approve-deposit', { userId: e.target.dataset.userid, txid: e.target.dataset.txid, amount: parseFloat(amount) });
                }
                if (e.target.classList.contains('reject-deposit-btn')) {
                    handleApiAction('/api/admin/reject-deposit', { userId: e.target.dataset.userid, txid: e.target.dataset.txid });
                }
                if (e.target.classList.contains('approve-withdrawal-btn')) {
                    handleApiAction('/api/admin/approve-withdrawal', { userId: e.target.dataset.userid, txid: e.target.dataset.txid });
                }
                if (e.target.classList.contains('reject-withdrawal-btn')) {
                    handleApiAction('/api/admin/reject-withdrawal', { userId: e.target.dataset.userid, txid: e.target.dataset.txid });
                }
            });

            creditForm.addEventListener('submit', e => {
                e.preventDefault();
                const username = document.getElementById('credit-username').value;
                const amount = document.getElementById('credit-amount').value;
                handleApiAction('/api/admin/credit-user', { username, amount });
                creditForm.reset();
            });

            commissionForm.addEventListener('submit', e => {
                e.preventDefault();
                const username = document.getElementById('commission-username').value;
                const amount = document.getElementById('commission-amount').value;
                handleApiAction('/api/admin/give-commission', { username, amount });
                commissionForm.reset();
            });
            
            if (getAdminKey()) { fetchData(); } else { showLogin(); }
        });
    </script>
</body>
</html>
